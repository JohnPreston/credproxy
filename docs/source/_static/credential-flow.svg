<?xml version="1.0" encoding="UTF-8"?>
<svg width="900" height="700" xmlns="http://www.w3.org/2000/svg">
  <!-- Arrow markers (must be defined before use) -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
    </marker>
    <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#1976d2"/>
    </marker>
    <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#388e3c"/>
    </marker>
    <marker id="arrowhead-orange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ff9800"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="900" height="700" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2"/>

  <!-- Title -->
  <text x="450" y="25" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#212529">
    CredProxy Credential Flow: Two-Step Role Assumption
  </text>

  <!-- Main Components -->
  <!-- CredProxy -->
  <rect x="50" y="60" width="200" height="100" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="5"/>
  <text x="150" y="85" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#1976d2">
    CredProxy
  </text>
  <text x="150" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#424242">
    Base Credentials:
  </text>
  <text x="150" y="120" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">
    IAM Profile / Keys
  </text>
  <text x="150" y="135" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">
    (sts:AssumeRole only)
  </text>
  <text x="150" y="150" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">
    localhost:1338
  </text>

  <!-- AWS STS -->
  <rect x="350" y="60" width="200" height="100" fill="#e8f5e8" stroke="#388e3c" stroke-width="2" rx="5"/>
  <text x="450" y="85" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#388e3c">
    AWS STS
  </text>
  <text x="450" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#424242">
    Role Assumption
  </text>
  <text x="450" y="120" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">
    AssumeRole API
  </text>
  <text x="450" y="135" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">
    Returns temporary creds
  </text>
  <text x="450" y="150" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">
    (1 hour TTL)
  </text>

  <!-- Application Container -->
  <rect x="650" y="60" width="200" height="100" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="2" rx="5"/>
  <text x="750" y="85" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#7b1fa2">
    Application Container
  </text>
  <text x="750" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#424242">
    Receives Role Credentials
  </text>
  <text x="750" y="120" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">
    AccessKeyId
  </text>
  <text x="750" y="135" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">
    SecretAccessKey + SessionToken
  </text>
  <text x="750" y="150" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">
    AWS SDK Operations
  </text>

  <!-- Step 1: Initial Setup -->
  <text x="50" y="200" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#212529">
    STEP 1: CredProxy Startup
  </text>

  <rect x="50" y="210" width="800" height="80" fill="#fff" stroke="#dee2e6" stroke-width="1" rx="3"/>

  <!-- 1a. Load Config -->
  <rect x="70" y="220" width="150" height="60" fill="#e3f2fd" stroke="#1976d2" stroke-width="1" rx="3"/>
  <text x="145" y="240" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#1976d2">
    1A. Load Configuration
  </text>
  <text x="145" y="255" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    config.yaml
  </text>
  <text x="145" y="270" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Base credentials
  </text>

  <!-- Arrow from 1a to 1b -->
  <line x1="230" y1="250" x2="270" y2="250" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- 1b. Start Server -->
  <rect x="280" y="220" width="150" height="60" fill="#e3f2fd" stroke="#1976d2" stroke-width="1" rx="3"/>
  <text x="355" y="240" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#1976d2">
    1B. Start HTTP Server
  </text>
  <text x="355" y="255" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    localhost:1338
  </text>
  <text x="355" y="270" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Health check ready
  </text>

  <!-- Arrow from 1b to 1c -->
  <line x1="440" y1="250" x2="480" y2="250" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- 1c. Validate Base Credentials -->
  <rect x="490" y="220" width="150" height="60" fill="#e3f2fd" stroke="#1976d2" stroke-width="1" rx="3"/>
  <text x="565" y="240" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#1976d2">
    1C. Validate Base Creds
  </text>
  <text x="565" y="255" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Can assume roles?
  </text>
  <text x="565" y="270" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    sts:AssumeRole only
  </text>

  <!-- Arrow from 1c to 1d -->
  <line x1="650" y1="250" x2="690" y2="250" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- 1d. Ready -->
  <rect x="700" y="220" width="130" height="60" fill="#e8f5e8" stroke="#388e3c" stroke-width="1" rx="3"/>
  <text x="765" y="240" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#388e3c">
    1D. Ready
  </text>
  <text x="765" y="255" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Awaiting requests
  </text>
  <text x="765" y="270" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Health endpoint live
  </text>

  <!-- Step 2: Application Request -->
  <text x="50" y="320" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#212529">
    STEP 2: Application Requests Credentials
  </text>

  <rect x="50" y="330" width="800" height="80" fill="#fff" stroke="#dee2e6" stroke-width="1" rx="3"/>

  <!-- 2a. App needs AWS -->
  <rect x="70" y="340" width="150" height="60" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="1" rx="3"/>
  <text x="145" y="360" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#7b1fa2">
    2A. App Needs AWS
  </text>
  <text x="145" y="375" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    AWS SDK call
  </text>
  <text x="145" y="390" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Needs credentials
  </text>

  <!-- Arrow from 2a to 2b -->
  <line x1="230" y1="370" x2="270" y2="370" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- 2b. HTTP Request -->
  <rect x="280" y="340" width="150" height="60" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="1" rx="3"/>
  <text x="355" y="360" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#7b1fa2">
    2B. HTTP Request
  </text>
  <text x="355" y="375" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    GET localhost:1338/
  </text>
  <text x="355" y="390" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Authorization: token
  </text>

  <!-- Arrow from 2b to 2c -->
  <line x1="440" y1="370" x2="480" y2="370" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- 2c. Validate Token -->
  <rect x="490" y="340" width="150" height="60" fill="#e3f2fd" stroke="#1976d2" stroke-width="1" rx="3"/>
  <text x="565" y="360" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#1976d2">
    2C. Validate Token
  </text>
  <text x="565" y="375" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Match service config
  </text>
  <text x="565" y="390" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Get role ARN
  </text>

  <!-- Arrow from 2c to 2d -->
  <line x1="650" y1="370" x2="690" y2="370" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- 2d. Identify Role -->
  <rect x="700" y="340" width="130" height="60" fill="#e8f5e8" stroke="#388e3c" stroke-width="1" rx="3"/>
  <text x="765" y="360" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#388e3c">
    2D. Identify Role
  </text>
  <text x="765" y="375" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    arn:aws:iam::123:
  </text>
  <text x="765" y="390" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    role/AppRole
  </text>

  <!-- Step 3: Role Assumption -->
  <text x="50" y="440" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#212529">
    STEP 3: CredProxy Assumes Role (Using Base Credentials)
  </text>

  <rect x="50" y="450" width="800" height="80" fill="#fff" stroke="#dee2e6" stroke-width="1" rx="3"/>

  <!-- 3a. STS AssumeRole -->
  <rect x="70" y="460" width="200" height="60" fill="#e3f2fd" stroke="#1976d2" stroke-width="1" rx="3"/>
  <text x="170" y="480" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#1976d2">
    3A. STS AssumeRole Call
  </text>
  <text x="170" y="495" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Uses BASE credentials
  </text>
  <text x="170" y="510" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    RoleArn: arn:aws:iam::123:role/AppRole
  </text>

  <!-- Arrow from 3a to 3b -->
  <line x1="280" y1="490" x2="320" y2="490" stroke="#1976d2" stroke-width="2" marker-end="url(#arrowhead-blue)"/>

  <!-- 3b. AWS Returns -->
  <rect x="330" y="460" width="200" height="60" fill="#e8f5e8" stroke="#388e3c" stroke-width="1" rx="3"/>
  <text x="430" y="480" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#388e3c">
    3B. AWS Returns Temp Creds
  </text>
  <text x="430" y="495" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Role-based credentials
  </text>
  <text x="430" y="510" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    AccessKeyId + SecretKey + Token
  </text>

  <!-- Arrow from 3b to 3c -->
  <line x1="540" y1="490" x2="580" y2="490" stroke="#388e3c" stroke-width="2" marker-end="url(#arrowhead-green)"/>

  <!-- 3c. Cache in Memory -->
  <rect x="590" y="460" width="240" height="60" fill="#fff3e0" stroke="#ff9800" stroke-width="1" rx="3"/>
  <text x="710" y="480" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#ff9800">
    3C. Cache in Memory
  </text>
  <text x="710" y="495" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Service-specific cache
  </text>
  <text x="710" y="510" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Auto-refresh 5min before expiry
  </text>

  <!-- Step 4: Return to Application -->
  <text x="50" y="560" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#212529">
    STEP 4: Return Role Credentials to Application
  </text>

  <rect x="50" y="570" width="800" height="80" fill="#fff" stroke="#dee2e6" stroke-width="1" rx="3"/>

  <!-- 4a. HTTP Response -->
  <rect x="70" y="580" width="200" height="60" fill="#e3f2fd" stroke="#1976d2" stroke-width="1" rx="3"/>
  <text x="170" y="600" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#1976d2">
    4A. HTTP Response
  </text>
  <text x="170" y="615" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    JSON with role credentials
  </text>
  <text x="170" y="630" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    NOT base credentials
  </text>

  <!-- Arrow from 4a to 4b -->
  <line x1="280" y1="610" x2="320" y2="610" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- 4b. App Receives -->
  <rect x="330" y="580" width="200" height="60" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="1" rx="3"/>
  <text x="430" y="600" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#7b1fa2">
    4B. App Receives Role Creds
  </text>
  <text x="430" y="615" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    AWS SDK caches them
  </text>
  <text x="430" y="630" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Makes AWS calls with role perms
  </text>

  <!-- Arrow from 4b to 4c -->
  <line x1="540" y1="610" x2="580" y2="610" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- 4c. AWS Operations -->
  <rect x="590" y="580" width="240" height="60" fill="#e8f5e8" stroke="#388e3c" stroke-width="1" rx="3"/>
  <text x="710" y="600" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#388e3c">
    4C. AWS Operations
  </text>
  <text x="710" y="615" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Using role-based permissions
  </text>
  <text x="710" y="630" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#424242">
    Least privilege for specific tasks
  </text>

  <!-- Key Security Points -->
  <rect x="50" y="660" width="800" height="30" fill="#fff3cd" stroke="#856404" stroke-width="2" rx="3"/>
  <text x="450" y="680" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#856404">
    ðŸ”’ KEY SECURITY: Base credentials ONLY assume roles. Applications ONLY receive role credentials. Never expose base credentials directly.
  </text>
</svg>
