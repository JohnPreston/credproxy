services:
  # The long-running credential provider service
  credproxy:
    image: ${REGISTRY:-public.ecr.aws}/${REPOSITORY:-compose-x/aws/credproxy}:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/Dockerfile
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        BUILD_DATE: ${BUILD_DATE:-unknown}
    restart: unless-stopped
    environment:
      AWS_PROFILE: ${AWS_PROFILE:-default}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-us-west-1}
    expose:
      - "1338/tcp"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
    healthcheck:
      test:
        - CMD
        - /bin/lprobe
        - -mode=http
        - -port=1338
        - -endpoint=/health
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Socat proxy sidecar for ECS metadata forwarding
  socat-proxy:
    image: ${REGISTRY:-public.ecr.aws}/${REPOSITORY:-compose-x/aws/credprox}:${IMAGE_TAG:-latest}-socat
    build:
      context: tooling/cloudformation
      dockerfile: dockerfiles/socat.Dockerfile
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    depends_on:
      credproxy:
        condition: service_healthy

## Example below shows how you can tether an application to a small sidecar that will handle passing your calls to credproxy
## in order to satisfy the SDK that the query is served locally
## Make sure that the connection between the socat and credproxy is secure.
# network_mode: service:aws-cli

# aws-cli:
#   image: public.ecr.aws/aws-cli/aws-cli:latest
#   command:
#     - sts
#     - get-caller-identity
#   environment:
#     #AWS_CONTAINER_CREDENTIALS_FULL_URI: http://169.254.170.2/v1/credentials
#     AWS_CONTAINER_CREDENTIALS_RELATIVE_URI: /v1/credentials
#     AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE: /run/secrets/aws-cli-token
#     AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-eu-west-1}
#     AWS_REGION: ${AWS_DEFAULT_REGION:-eu-west-1}
#   depends_on:
#     credproxy:
#       condition: service_healthy
#   secrets:
#     - aws-cli-token
#   networks:
#     - credproxy-net
